# UltraRAG Enterprise Agent POC 開發進度

**日期**: 2026-01-29
**部署 URL**: https://agent.tsicstudio.com
**備用 URL**: https://ultrarag-556560931446.us-west1.run.app

---

## 已完成功能

### 1. GCP Cloud Run 部署
- ✅ Docker 映像建置 (`cloudbuild.yaml`)
- ✅ Cloud Run 部署 (gen2 執行環境)
- ✅ 自訂域名映射 `agent.tsicstudio.com`
- ✅ SSL 憑證自動發放

### 2. Pipeline 執行計時功能
- ✅ 每個步驟顯示耗時 (秒)
- ✅ 步驟名稱後顯示 `(x.xx s)`
- ✅ 總計時間顯示在「Show Thinking」底部
- ✅ 後端 Log 記錄總耗時
- **修改檔案**:
  - `src/ultrarag/client.py` - 加入 `time_module.perf_counter()` 計時
  - `ui/frontend/main.js` - 顯示 `duration_ms` 和 `timing` 事件
  - `ui/frontend/style.css` - `.process-timing` 樣式

### 3. Agent Router 優化
- ✅ 新增技術文件關鍵字 (TMScript, TMflow, 達明, EIH, Pause 等)
- ✅ 改進中文分詞 (字元級別 n-gram)
- ✅ 新增 `_has_retrieved_documents()` 方法
- ✅ 只要知識庫有文件就優先使用 internal 路由
- **修改檔案**: `servers/agent_router/src/agent_router.py`

### 4. WebSearch Timeout 機制
- ✅ 預設 30 秒 timeout
- ✅ 超時後返回空結果，不卡住流程
- **修改檔案**: `servers/websearch/src/websearch.py`

### 5. Chat 附件上傳功能
- ✅ 前端「附件」按鈕 (支援 PDF, DOC, DOCX, TXT, MD)
- ✅ 檔案預覽區域 (輸入框上方)
- ✅ 後端 `/api/chat/parse-file` API 解析檔案
- ✅ 用戶訊息顯示附件標籤 (藍色 chip)
- ✅ 附件內容自動加入對話上下文
- **修改檔案**:
  - `ui/frontend/index.html` - 新增上傳按鈕和 file input
  - `ui/frontend/main.js` - `handleChatFileSelect()`, `updateAttachedFilesUI()`
  - `ui/frontend/style.css` - `.chat-file-upload`, `.user-attachment-chip`
  - `ui/backend/app.py` - `/api/chat/parse-file` 端點

### 6. 多輪對話 (Multi-turn Chat)
- ✅ Gemini backend streaming 支援
- ✅ Session 管理 (Cloud Run stateless 相容)
- ✅ 對話歷史由前端維護 (single source of truth)
- **修改檔案**:
  - `servers/generation/src/local_generation.py` - `_gemini_multiturn_stream()`
  - `ui/backend/pipeline_manager.py` - `chat_multiturn_stream()`

---

## 環境配置

### Cloud Run 設定
| 項目 | 值 |
|------|-----|
| Region | us-west1 |
| Memory | 4Gi |
| CPU | 2 |
| Timeout | 300s |
| 執行環境 | gen2 |

### 環境變數
| 變數 | 說明 |
|------|------|
| GOOGLE_API_KEY | Gemini API Key |
| MILVUS_URI | Milvus Cloud Endpoint |
| MILVUS_TOKEN | Milvus 認證 (user:password) |

### 自訂域名
- Domain: `agent.tsicstudio.com`
- DNS: Cloudflare CNAME → `ghs.googlehosted.com`
- Proxy: DNS only (灰色雲朵)

---

## 已知限制

1. **檔案大小限制**: Cloud Run 請求上限 32MB，前端限制 30MB
2. **Chat 附件**: 單檔 10MB，內容截斷 50,000 字元
3. **WebSearch**: 30 秒 timeout

---

## 下一步待辦

- [ ] 檔案上傳進度顯示
- [ ] 更多檔案格式支援 (xlsx, pptx)
- [ ] 對話匯出功能
- [ ] 使用者認證強化

---

## 部署指令

```bash
# 建置
gcloud builds submit --config cloudbuild.yaml

# 部署
gcloud run deploy ultrarag \
  --image gcr.io/my-website-harry123/ultrarag:latest \
  --region us-west1 \
  --platform managed \
  --allow-unauthenticated \
  --memory 4Gi \
  --cpu 2 \
  --timeout 300

# 檢查域名狀態
gcloud beta run domain-mappings describe --domain agent.tsicstudio.com --region us-west1
```
